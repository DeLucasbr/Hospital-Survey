{% extends "base.html" %}

{% block title %}Pesquisa de Satisfa√ß√£o - Hospital Santa Clara{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
        <div class="survey-container">
            <!-- Header da Pesquisa -->
            <div class="survey-header">
                <div class="logo-placeholder">
<<<<<<< HEAD
                    <img src="/static/images/logo.png" alt="Hospital Santa Clara" class="logo-img" style="height: 40px; width: auto; max-width: 150px; display: inline-block;">
=======
                    HOSPITAL SANTA CLARA
>>>>>>> 19d46c379748bbd568b8fbacd2fd278cd518370a
                </div>
                <h2 class="mb-0">Pesquisa de Satisfa√ß√£o</h2>
                <p class="mb-0 mt-2">Sua opini√£o √© muito importante para n√≥s!</p>
            </div>

            <!-- Se√ß√£o de Progresso -->
            <div class="progress-section">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p class="mb-0">
                    <span id="progress-text">0/10 quest√µes respondidas</span>
                </p>
                <div id="encouragement" class="encouragement">
                    Estamos come√ßando, sua opini√£o faz toda a diferen√ßa üíô
                </div>
            </div>

            <!-- Formul√°rio da Pesquisa -->
            <form id="survey-form" class="p-4">
                <!-- Informa√ß√µes do Paciente -->
                <div class="section mb-4">
                    <div class="section-header">
                        <i class="fas fa-user me-2"></i>
                        Informa√ß√µes do Paciente
                    </div>
                    <div class="section-content">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="patient_name" class="form-label">Nome do Paciente</label>
                                <input type="text" class="form-control" id="patient_name" name="patient_name">
                            </div>
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_anonymous" name="is_anonymous">
                                    <label class="form-check-label" for="is_anonymous">
                                        Prefiro permanecer an√¥nimo
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="admission_date" class="form-label">Data de Interna√ß√£o</label>
                                <input type="date" class="form-control" id="admission_date" name="admission_date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="discharge_date" class="form-label">Data de Alta</label>
                                <input type="date" class="form-control" id="discharge_date" name="discharge_date" required>
                            </div>
                        </div>
<<<<<<< HEAD
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="Ex.: S√£o Paulo">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ward" class="form-label">Setor de Atendimento</label>
                                <select class="form-select" id="ward" name="ward">
                                    <option value="">Selecione...</option>
                                    <option value="Ala Shibata">Ala Shibata</option>
                                    <option value="Ala Palandri">Ala Palandri</option>
                                    <option value="Pronto Atendimento">Pronto Atendimento</option>
                                    <option value="Hemodi√°lise">Hemodi√°lise</option>
                                </select>
                            </div>
                        </div>
=======
>>>>>>> 19d46c379748bbd568b8fbacd2fd278cd518370a
                    </div>
                </div>

                <!-- Se√ß√µes de Perguntas -->
                <div id="questions-container">
                    <!-- Perguntas ser√£o carregadas via JavaScript -->
                </div>

                <!-- Observa√ß√µes -->
                <div class="section mb-4">
                    <div class="section-header">
                        <i class="fas fa-comment me-2"></i>
                        Observa√ß√µes
                    </div>
                    <div class="section-content">
                        <label for="observations" class="form-label">
                            Coment√°rios ou sugest√µes adicionais (opcional)
                        </label>
                        <textarea class="form-control" id="observations" name="observations" rows="4" 
                                placeholder="Compartilhe sua experi√™ncia ou sugest√µes para melhorarmos nosso atendimento..."></textarea>
                    </div>
                </div>

                <!-- Bot√£o de Envio -->
                <div class="text-center">
                    <button type="submit" id="submit-btn" class="btn btn-primary-custom" disabled>
                        <i class="fas fa-paper-plane me-2"></i>
                        Enviar Pesquisa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Sucesso -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="text-success mb-3">
                    <i class="fas fa-check-circle" style="font-size: 3rem;"></i>
                </div>
                <h4 class="text-success mb-3">Pesquisa Enviada com Sucesso!</h4>
                <p>Muito obrigado por seu tempo e feedback. Sua opini√£o nos ajuda a melhorar continuamente nossos servi√ßos.</p>
                <button type="button" class="btn btn-primary-custom" onclick="resetForm()">
                    Nova Pesquisa
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let questionsData = [];
let currentResponses = {};
let totalQuestions = 10;

// Carregar perguntas da API
async function loadQuestions() {
    try {
        const response = await fetch('/api/questions');
        questionsData = await response.json();
        renderQuestions();
    } catch (error) {
        console.error('Erro ao carregar perguntas:', error);
        // Fallback com dados est√°ticos
        loadFallbackQuestions();
    }
}

function loadFallbackQuestions() {
    // Dados de fallback caso a API n√£o esteja funcionando
    questionsData = [
        {
            "title": "Se√ß√£o 1: Atendimento",
            "questions": [
                {
                    "id": "q1_1",
                    "text": "1. Como voc√™ avaliaria a qualidade do atendimento recebido no hospital?",
                    "options": ["Muito satisfeito(a)", "Satisfeito(a)", "Neutro(a)", "Insatisfeito(a)", "Muito insatisfeito(a)"]
                },
                {
                    "id": "q1_2",
                    "text": "2. Os profissionais de sa√∫de foram atenciosos e respeitosos com voc√™?",
                    "options": ["Sim", "N√£o", "Em parte"]
                },
                {
                    "id": "q1_3",
                    "text": "3. Voc√™ sentiu que suas necessidades foram atendidas de forma eficaz?",
                    "options": ["Sim", "N√£o", "Em parte"]
                }
            ]
        },
        {
            "title": "Se√ß√£o 2: Instala√ß√µes e recursos",
            "questions": [
                {
                    "id": "q2_1",
                    "text": "1. Como voc√™ avaliaria as instala√ß√µes do hospital (limpeza, conforto, etc.)?",
                    "options": ["Muito satisfeito(a)", "Satisfeito(a)", "Neutro(a)", "Insatisfeito(a)", "Muito insatisfeito(a)"]
                },
                {
                    "id": "q2_2",
                    "text": "2. Os equipamentos e recursos dispon√≠veis no hospital foram suficientes para o seu tratamento?",
                    "options": ["Sim", "N√£o", "Em parte"]
                }
            ]
        },
        {
            "title": "Se√ß√£o 3: Comunica√ß√£o",
            "questions": [
                {
                    "id": "q3_1",
                    "text": "1. Voc√™ sentiu que os profissionais de sa√∫de explicaram claramente o seu diagn√≥stico e tratamento?",
                    "options": ["Sim", "N√£o", "Em parte"]
                },
                {
                    "id": "q3_2",
                    "text": "2. Voc√™ foi informado sobre os seus direitos e responsabilidades como paciente?",
                    "options": ["Sim", "N√£o", "Em parte"]
                }
            ]
        },
        {
            "title": "Se√ß√£o 4: Filantropia e apoio",
            "questions": [
                {
                    "id": "q4_1",
                    "text": "1. Voc√™ sabe que o hospital √© filantr√≥pico e que sua miss√£o √© ajudar aqueles que n√£o t√™m recursos?",
                    "options": ["Sim", "N√£o"]
                },
                {
                    "id": "q4_2",
                    "text": "2. Voc√™ sente que o hospital est√° fazendo uma diferen√ßa positiva na comunidade?",
                    "options": ["Sim", "N√£o", "Em parte"]
                }
            ]
        },
        {
            "title": "Se√ß√£o 5: Recomenda√ß√£o",
            "questions": [
                {
                    "id": "q5_1",
                    "text": "1. Voc√™ recomendaria este hospital para amigos e familiares?",
                    "options": ["Sim", "N√£o", "Em parte"]
                }
            ]
        }
    ];
    renderQuestions();
}

function renderQuestions() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';

    totalQuestions = questionsData.reduce((total, section) => total + section.questions.length, 0);

    questionsData.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section mb-4';

        sectionDiv.innerHTML = `
            <div class="section-header">
                <i class="fas fa-clipboard-list me-2"></i>
                ${section.title}
            </div>
            <div class="section-content">
                ${section.questions.map(question => `
                    <div class="question">
                        <div class="question-text">${question.text}</div>
                        ${question.options.map(option => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="${question.id}" value="${option}" 
                                       id="${question.id}_${option.replace(/[^a-zA-Z0-9]/g, '_')}"
                                       onchange="updateProgress()">
                                <label class="form-check-label" 
                                       for="${question.id}_${option.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    ${option}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            </div>
        `;

        container.appendChild(sectionDiv);
    });

    updateProgress();
}

function updateProgress() {
    // Contar quest√µes respondidas
    const answered = new Set();
    const radios = document.querySelectorAll('input[type="radio"]:checked');

    radios.forEach(radio => {
        answered.add(radio.name);
        currentResponses[radio.name] = radio.value;
    });

    const progress = (answered.size / totalQuestions) * 100;
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const encouragement = document.getElementById('encouragement');
    const submitBtn = document.getElementById('submit-btn');

    // Atualizar barra de progresso
    progressBar.style.width = progress + '%';
    progressText.textContent = `${answered.size}/${totalQuestions} quest√µes respondidas`;

    // Atualizar cor da barra
    if (progress < 30) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (progress < 70) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }

    // Atualizar mensagem de encorajamento
    let message = '';
    if (progress === 100) {
        message = "Perfeito! Muito obrigado por concluir a pesquisa ‚ù§Ô∏è";
    } else if (progress >= 71) {
        message = "Quase l√°, obrigado por compartilhar sua experi√™ncia ‚ú®";
    } else if (progress >= 31) {
        message = "Voc√™ est√° indo muito bem, continue! üôè";
    } else {
        message = "Estamos come√ßando, sua opini√£o faz toda a diferen√ßa üíô";
    }
    encouragement.textContent = message;

    // Habilitar/desabilitar bot√£o de envio
    submitBtn.disabled = answered.size < totalQuestions;
}

// Controlar checkbox an√¥nimo
document.getElementById('is_anonymous').addEventListener('change', function() {
    const nameField = document.getElementById('patient_name');
    if (this.checked) {
        nameField.value = '';
        nameField.disabled = true;
        nameField.placeholder = 'An√¥nimo';
    } else {
        nameField.disabled = false;
        nameField.placeholder = '';
    }
});

// Envio do formul√°rio
document.getElementById('survey-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    submitBtn.disabled = true;

    try {
        const formData = new FormData(this);

        // Adicionar respostas das quest√µes
        Object.entries(currentResponses).forEach(([key, value]) => {
            formData.append(key, value);
        });

        const response = await fetch('/api/submit-survey', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            // Mostrar modal de sucesso
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        alert('Erro ao enviar pesquisa: ' + error.message);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

function resetForm() {
    document.getElementById('survey-form').reset();
    currentResponses = {};
    updateProgress();

    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
    modal.hide();

    // Scroll para o topo
    window.scrollTo(0, 0);
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    loadQuestions();
});
</script>
{% endblock %}